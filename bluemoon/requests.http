# File: requests.http
# 
# Bi·∫øn @host d√πng chung cho t·∫•t c·∫£ request
@host = http://localhost:3000

# ==================================================
# K·ªäCH B·∫¢N 1: THI·∫æT L·∫¨P D·ªÆ LI·ªÜU (VAI TR√í ADMIN)
# (Ch·∫°y c√°c b∆∞·ªõc n√†y theo th·ª© t·ª± ƒë·ªÉ t·∫°o d·ªØ li·ªáu m·∫´u)
# ==================================================

### (Admin) 1.1: ƒêƒÉng nh·∫≠p t√†i kho·∫£n Admin
# @name loginAdmin
POST {{host}}/api/auth/login
Content-Type: application/json

{
    "username": "admin",
    "password": "password123"
}

### --- Ph·∫£i c√≥ 3 d·∫•u # ƒë·ªÉ t√°ch script g√°n bi·∫øn ---
@adminToken = {{loginAdmin.response.body.token}}


### (Admin) 1.2: T·∫°o t√†i kho·∫£n K·∫ø to√°n (ID role = 2)
# @name createKetoan
POST {{host}}/api/auth/users
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "username": "ketoan01",
    "fullName": "K·∫ø to√°n 01",
    "roleId": 2
}


### (Admin) 1.3: T·∫°o t√†i kho·∫£n C∆∞ d√¢n (ID role = 3)
# (C·∫ßn thi·∫øt cho K·ªãch b·∫£n 5, 6, 7)
# @name createCudan
POST {{host}}/api/auth/users
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "username": "cudan01",
    "fullName": "C∆∞ d√¢n 01 (H·ªô 101)",
    "roleId": 3
}

### (Admin) 1.4: T·∫°o h·ªì s∆° c∆∞ d√¢n (Qu·∫£n l√Ω nh√¢n kh·∫©u)
# @name createResident
POST {{host}}/api/residents
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "fullName": "Nguy·ªÖn VƒÉn A (H·ªô 101)",
    "apartmentNumber": "101",
    "phoneNumber": "0909123456"
}

# ==================================================
# K·ªäCH B·∫¢N 2: TEST PH√ÇN QUY·ªÄN (VAI TR√í K·∫æ TO√ÅN)
# ==================================================

### (K·∫ø to√°n) 2.1: ƒêƒÉng nh·∫≠p t√†i kho·∫£n K·∫ø to√°n
# @name loginKetoan
POST {{host}}/api/auth/login
Content-Type: application/json

{
    "username": "ketoan01",
    "password": "12345678"
}

### --- Ph·∫£i c√≥ 3 d·∫•u # ƒë·ªÉ t√°ch script g√°n bi·∫øn ---
@ketoanToken = {{loginKetoan.response.body.token}}


### (K·∫ø to√°n) 2.2: Test quy·ªÅn User - Xem l·ªãch s·ª≠ c·ªßa CH√çNH M√åNH
# (PH·∫¢I TH√ÄNH C√îNG ‚úÖ)
GET {{host}}/api/auth/login-history/me
Authorization: Bearer {{ketoanToken}}


### (K·∫ø to√°n) 2.3: Test quy·ªÅn User - T·ª± ƒë·ªïi m·∫≠t kh·∫©u
# (PH·∫¢I TH√ÄNH C√îNG ‚úÖ)
POST {{host}}/api/auth/change-password
Authorization: Bearer {{ketoanToken}}
Content-Type: application/json

{
    "oldPassword": "12345678",
    "newPassword": "123456789"
}


### (K·∫ø to√°n) 2.4: Test Ph√¢n Quy·ªÅn - C·ªë g·∫Øng xem l·ªãch s·ª≠ T·∫§T C·∫¢ user
# (PH·∫¢I TH·∫§T B·∫†I ‚õî - 403 Forbidden)
GET {{host}}/api/auth/login-history/all
Authorization: Bearer {{ketoanToken}}


### (K·∫ø to√°n) 2.5: Test Ph√¢n Quy·ªÅn - C·ªë g·∫Øng T·∫†O user m·ªõi
# (PH·∫¢I TH·∫§T B·∫†I ‚õî - 403 Forbidden)
POST {{host}}/api/auth/users
Authorization: Bearer {{ketoanToken}}
Content-Type: application/json

{
    "username": "cudan_test",
    "fullName": "C∆∞ d√¢n Test",
    "roleId": 3
}

# ==================================================
# K·ªäCH B·∫¢N 3: QU·∫¢N L√ù C∆Ø D√ÇN (US_002, 003, 005)
# (D√πng token Admin)
# ==================================================

### (Admin) 3.1: (US_002) Xem T·∫§T C·∫¢ c∆∞ d√¢n (kh√¥ng l·ªçc)
GET {{host}}/api/residents
Authorization: Bearer {{adminToken}}

### (Admin) 3.2: (US_005) L·ªçc c∆∞ d√¢n theo t√™n "Nguy·ªÖn"
GET {{host}}/api/residents?name=Nguy·ªÖn
Authorization: Bearer {{adminToken}}

### (Admin) 3.3: (US_003) Ch·ªânh s·ª≠a th√¥ng tin c∆∞ d√¢n (ID = 1)
# Gi·∫£ s·ª≠ c∆∞ d√¢n "Nguy·ªÖn VƒÉn A" v·ª´a t·∫°o c√≥ ID = 1
PUT {{host}}/api/residents/1
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "phone_number": "0987654321",
    "status": "ƒê√£ chuy·ªÉn ƒëi"
}

### (Admin) 3.4: X√≥a c∆∞ d√¢n (ID = 1)
# (PH·∫¢I TH√ÄNH C√îNG ‚úÖ)
DELETE {{host}}/api/residents/1
Authorization: Bearer {{adminToken}}

# ==================================================
# K·ªäCH B·∫¢N 4: QU·∫¢N L√ù PH√ç (US_011) (M·ªöI)
# (D√πng token K·∫ø to√°n)
# ==================================================

### (K·∫ø to√°n) 4.1: (US_011) T·∫°o lo·∫°i ph√≠ "Ph√≠ qu·∫£n l√Ω"
# @name createFee1
POST {{host}}/api/fees
Authorization: Bearer {{ketoanToken}}
Content-Type: application/json

{
    "name": "Ph√≠ qu·∫£n l√Ω",
    "description": "Ph√≠ qu·∫£n l√Ω v·∫≠n h√†nh chung c∆∞",
    "amount": 10000,
    "unit": "VND/m2/th√°ng"
}

### (K·∫ø to√°n) 4.2: (US_011) T·∫°o lo·∫°i ph√≠ "Ph√≠ g·ª≠i xe m√°y"
# @name createFee2
POST {{host}}/api/fees
Authorization: Bearer {{ketoanToken}}
Content-Type: application/json

{
    "name": "Ph√≠ g·ª≠i xe m√°y",
    "amount": 70000,
    "unit": "VND/xe/th√°ng"
}

### (K·∫ø to√°n) 4.3: (US_011) Xem t·∫•t c·∫£ c√°c lo·∫°i ph√≠
GET {{host}}/api/fees
Authorization: Bearer {{ketoanToken}}

### (K·∫ø to√°n) 4.4: (US_011) C·∫≠p nh·∫≠t gi√° "Ph√≠ g·ª≠i xe m√°y" (ID = 2)
PUT {{host}}/api/fees/2
Authorization: Bearer {{ketoanToken}}
Content-Type: application/json

{
    "amount": 80000,
    "description": "Ph√≠ g·ª≠i xe m√°y (ƒë√£ ƒëi·ªÅu ch·ªânh)"
}

### (K·∫ø to√°n) 4.5: (US_011) H·ªßy/T·∫Øt lo·∫°i ph√≠ "Ph√≠ qu·∫£n l√Ω" (ID = 1)
DELETE {{host}}/api/fees/1
Authorization: Bearer {{ketoanToken}}


# ==================================================
# K·ªäCH B·∫¢N 5: QU·∫¢N L√ù H√ìA ƒê∆†N (US_012, 013) (M·ªöI)
# ==================================================

### (K·∫ø to√°n) 5.1: (US_012) T·∫°o h√≥a ƒë∆°n "Ph√≠ g·ª≠i xe" cho C∆∞ d√¢n 01
# (Gi·∫£ s·ª≠ C∆∞ d√¢n 01 c√≥ ID = 3, Ph√≠ xe m√°y c√≥ ID = 2)
POST {{host}}/api/invoices
Authorization: Bearer {{ketoanToken}}
Content-Type: application/json

{
    "user_ids": [3],
    "fee_type_id": 2,
    "month": 10,
    "year": 2025,
    "due_date": "2025-10-31" 
}

### (K·∫ø to√°n) 5.2: (US_011 - Test) C·ªë g·∫Øng t·∫°o Hƒê v·ªõi ng√†y qu√° h·∫°n
# (PH·∫¢I TH·∫§T B·∫†I ‚õî - 400 Bad Request)
POST {{host}}/api/invoices
Authorization: Bearer {{ketoanToken}}
Content-Type: application/json

{
    "user_ids": [3],
    "fee_type_id": 2,
    "month": 9,
    "year": 2025,
    "due_date": "2025-10-01" 
}

### (C∆∞ d√¢n) 5.3: (US_012) C∆∞ d√¢n ƒëƒÉng nh·∫≠p
# @name loginCudan_Invoice
POST {{host}}/api/auth/login
Content-Type: application/json

{
    "username": "cudan01",
    "password": "12345678"
}

### --- Ph·∫£i c√≥ 3 d·∫•u # ƒë·ªÉ t√°ch script g√°n bi·∫øn ---
@cudanToken_Invoice = {{loginCudan_Invoice.response.body.token}}


### (C∆∞ d√¢n) 5.4: (US_012) C∆∞ d√¢n xem h√≥a ƒë∆°n c·ªßa m√¨nh
# (S·∫Ω th·∫•y Hƒê Ph√≠ g·ª≠i xe 80.000ƒë)
GET {{host}}/api/invoices/my
Authorization: Bearer {{cudanToken_Invoice}}

### (C∆∞ d√¢n) 5.5: (US_012) C∆∞ d√¢n b·∫•m n√∫t "Thanh to√°n"
# (Gi·∫£ s·ª≠ Hƒê v·ª´a t·∫°o c√≥ ID = 1)
# @name getPaymentLink
POST {{host}}/api/invoices/1/pay
Authorization: Bearer {{cudanToken_Invoice}}

### --- Ph·∫£i c√≥ 3 d·∫•u # ƒë·ªÉ t√°ch script g√°n bi·∫øn ---
@paymentUrl = {{getPaymentLink.response.body.paymentUrl}}


### (C∆∞ d√¢n) 5.6: (US_012) Gi·∫£ l·∫≠p C∆∞ d√¢n thanh to√°n
# (Tr√¨nh duy·ªát s·∫Ω t·ª± ƒë·ªông g·ªçi link n√†y. KH√îNG C·∫¶N TOKEN)
GET {{paymentUrl}}

### (C∆∞ d√¢n) 5.7: (US_012) C∆∞ d√¢n ki·ªÉm tra l·∫°i h√≥a ƒë∆°n
# (S·∫Ω th·∫•y status: "ƒê√£ thanh to√°n")
GET {{host}}/api/invoices/my
Authorization: Bearer {{cudanToken_Invoice}}


# ==================================================
# K·ªäCH B·∫¢N 6: G·ª¨I TH√îNG B√ÅO (US_015)
# (D√πng token Admin)
# ==================================================

### (Admin) 6.1: (US_015) G·ª≠i th√¥ng b√°o cho T·∫§T C·∫¢ user "C∆∞ d√¢n"
POST {{host}}/api/notifications
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "title": "Th√¥ng b√°o chung v·ªÅ l·ªãch c·∫Øt n∆∞·ªõc",
    "content": "To√†n b·ªô chung c∆∞ s·∫Ω c·∫Øt n∆∞·ªõc t·ª´ 8h-10h s√°ng mai.",
    "target": { "type": "all_residents" }
}

### (Admin) 6.2: (US_015) G·ª≠i th√¥ng b√°o cho user "C∆∞ d√¢n" C·ª§ TH·ªÇ
# (Gi·∫£ s·ª≠ cudan01 c√≥ ID = 3)
POST {{host}}/api/notifications
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "title": "Th√¥ng b√°o thu ph√≠ cƒÉn h·ªô 101",
    "content": "Y√™u c·∫ßu h·ªô 101 thanh to√°n ph√≠ d·ªãch v·ª• th√°ng 10.",
    "target": { "type": "specific_users", "ids": [3] }
}

### (Admin) 6.3: (US_015) G·ª≠i th√¥ng b√°o cho user kh√¥ng ph·∫£i C∆∞ d√¢n
# (Gi·∫£ s·ª≠ ketoan01 c√≥ ID = 2)
POST {{host}}/api/notifications
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "title": "Th√¥ng b√°o cho K·∫ø to√°n",
    "content": "Vui l√≤ng chu·∫©n b·ªã b√°o c√°o.",
    "target": { "type": "specific_users", "ids": [2] }
}


### (Admin) 6.4: L·∫•y danh s√°ch t·∫•t c·∫£ th√¥ng b√°o ƒë√£ g·ª≠i
GET {{host}}/api/notifications
Authorization: Bearer {{adminToken}}

# ==================================================
# K·ªäCH B·∫¢N 7: VAI TR√í C∆Ø D√ÇN (US_016, US_017)
# ==================================================

### (C∆∞ d√¢n) 7.1: ƒêƒÉng nh·∫≠p t√†i kho·∫£n C∆∞ d√¢n
# @name loginCudan
POST {{host}}/api/auth/login
Content-Type: application/json

{
    "username": "cudan01",
    "password": "12345678"
}

### --- Ph·∫£i c√≥ 3 d·∫•u # ƒë·ªÉ t√°ch script g√°n bi·∫øn ---
@cudanToken = {{loginCudan.response.body.token}}


### (C∆∞ d√¢n) 7.2: (US_016) Xem l·ªãch s·ª≠ th√¥ng b√°o c·ªßa t√¥i (Icon chu√¥ng üîî)
# (PH·∫¢I TH√ÄNH C√îNG ‚úÖ - S·∫Ω th·∫•y 2 th√¥ng b√°o t·ª´ K·ªãch b·∫£n 6)
GET {{host}}/api/notifications/my
Authorization: Bearer {{cudanToken}}


### (C∆∞ d√¢n) 7.3: (US_016) ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc th√¥ng b√°o
# Gi·∫£ s·ª≠ th√¥ng b√°o "l·ªãch c·∫Øt n∆∞·ªõc" c√≥ ID = 1
PUT {{host}}/api/notifications/read/1
Authorization: Bearer {{cudanToken}}


### (C∆∞ d√¢n) 7.4: (US_017) G·ª≠i ph·∫£n √°nh s·ª± c·ªë (H·ªèng thang m√°y)
# (PH·∫¢I TH√ÄNH C√îNG ‚úÖ)
POST {{host}}/api/incidents
Authorization: Bearer {{cudanToken}}
Content-Type: application/json

{
    "title": "Thang m√°y s·∫£nh B kh√¥ng ho·∫°t ƒë·ªông",
    "description": "Thang m√°y B2 (thang ch·ªü h√†ng) k·∫πt ·ªü t·∫ßng 10, c·ª≠a kh√¥ng m·ªü.",
    "location": "Thang m√°y B2"
}

### (C∆∞ d√¢n) 7.5: (US_017) Xem l·∫°i c√°c s·ª± c·ªë t√¥i ƒë√£ g·ª≠i
# (PH·∫¢I TH√ÄNH C√îNG ‚úÖ)
GET {{host}}/api/incidents/my
Authorization: Bearer {{cudanToken}}


### (C∆∞ d√¢n) 7.6: (Test Ph√¢n Quy·ªÅn) C∆∞ d√¢n c·ªë g·∫Øng xem T·∫§T C·∫¢ s·ª± c·ªë
# (PH·∫¢I TH·∫§T B·∫†I ‚õî - 403 Forbidden)
GET {{host}}/api/incidents
Authorization: Bearer {{cudanToken}}

# ==================================================
# K·ªäCH B·∫¢N 8: QU·∫¢N L√ù PH·∫¢N √ÅNH (US_017)
# (D√πng token Admin)
# ==================================================

### (Admin) 8.1: (US_017) Admin xem l·∫°i t·∫•t c·∫£ s·ª± c·ªë ƒë√£ ƒë∆∞·ª£c c∆∞ d√¢n b√°o c√°o
# (S·∫Ω th·∫•y s·ª± c·ªë "Thang m√°y s·∫£nh B" do cudan01 g·ª≠i)
GET {{host}}/api/incidents
Authorization: Bearer {{adminToken}}


# ==================================================
# K·ªäCH B·∫¢N 9: ƒêƒÇNG XU·∫§T (TEST checkAuth)
# ==================================================

### (User b·∫•t k·ª≥) 9.1: Y√™u c·∫ßu ƒëƒÉng xu·∫•t
POST {{host}}/api/auth/logout
Authorization: Bearer {{cudanToken}}

### (Kh√°ch) 9.2: Test X√°c th·ª±c - C·ªë g·∫Øng truy c·∫≠p route b·∫£o v·ªá
# (PH·∫¢I TH·∫§T B·∫†I ‚õî - 401 Unauthorized)
# (V√¨ kh√¥ng g·ª≠i Authorization header)
GET {{host}}/api/auth/login-history/me